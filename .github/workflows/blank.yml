name: Windows-2025 Personal Cloud PC (Tailscale + RDP)

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: "Tailscale auth key"
        required: true
      pc_name:
        description: "Friendly name for your Cloud PC"
        required: true

jobs:
  cloud-pc-job:
    runs-on: windows-2025
    env:
      TAILSCALE_AUTH_KEY: ${{ github.event.inputs.tailscale_auth_key }}
      PC_NAME: ${{ github.event.inputs.pc_name }}
    steps:
      - name: ‚òÅÔ∏è Set PC Name
        shell: powershell
        run: |
          Rename-Computer -NewName $env:PC_NAME -Force -Restart:$false
          Write-Output "PC name set to $env:PC_NAME"

      - name: ‚ö° Create CloudPCUSER
        shell: powershell
        run: |
          $username = "CloudPCUSER"
          $password = "WindowsCloudPC#2025"
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force)
              Add-LocalGroupMember -Group "Administrators" -Member $username
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          }

      - name: üåê Install & Authenticate Tailscale
        shell: powershell
        run: |
          # Download installer
          $installer = "$env:TEMP\tailscale-setup.exe"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile $installer

          # Install Tailscale and wait
          Start-Process msiexec.exe -ArgumentList "/i `"$installer`" /quiet /norestart" -Wait

          # Wait up to 2 minutes for Tailscale executable
          $paths = @(
              "C:\Program Files (x86)\Tailscale IPN\tailscale.exe",
              "C:\Program Files\Tailscale IPN\tailscale.exe"
          )
          $tailscaleExe = $null
          $timeout = (Get-Date).AddMinutes(2)
          while (-not $tailscaleExe -and (Get-Date) -lt $timeout) {
              $tailscaleExe = $paths | Where-Object { Test-Path $_ } | Select-Object -First 1
              if (-not $tailscaleExe) { Start-Sleep -Seconds 5 }
          }

          if (-not $tailscaleExe) { Write-Error "Tailscale executable not found after 2 minutes!"; exit 1 }

          # Authenticate Tailscale
          Start-Process $tailscaleExe -ArgumentList "up --authkey $env:TAILSCALE_AUTH_KEY --hostname $env:COMPUTERNAME" -Wait
          Write-Output "Tailscale node authenticated"

      - name: üñ•Ô∏è Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: ‚è≥ Keep Alive Loop
        shell: powershell
        run: |
          $scriptPath = "$env:TEMP\cloudpc_keepalive.ps1"
          $lines = @(
            '$username = "CloudPCUSER"',
            '$password = "WindowsCloudPC#2025"',
            '$pcName = "' + $env:PC_NAME + '"',
            '$paths = @("C:\Program Files (x86)\Tailscale IPN\tailscale.exe","C:\Program Files\Tailscale IPN\tailscale.exe")',
            '$tailscaleExe = $paths | Where-Object { Test-Path $_ } | Select-Object -First 1',
            '$tailscaleIP = (& $tailscaleExe ip -4).Trim()',
            '$tailscaleNodeName = (& $tailscaleExe status | Select-String "hostname:").ToString().Split(":")[1].Trim()',
            '$endTime = (Get-Date).AddHours(5)',
            'while ((Get-Date) -lt $endTime) {',
            '    Write-Output "üéâ Your personal Cloud PC $pcName is ready!"',
            '    Write-Output "üîë Login user: $username"',
            '    Write-Output "üíª Password: $password"',
            '    Write-Output "üåê Tailscale IP: $tailscaleIP"',
            '    Write-Output "üìõ Tailscale Node Name: $tailscaleNodeName"',
            '    Write-Output "Connect via RDP using the above credentials."',
            '    Start-Sleep -Seconds 60',
            '}',
            'Write-Output "‚è∞ 5 hours reached. Cloud PC job completed. ‚úÖ"'
          )
          $lines | Set-Content $scriptPath
          powershell -File $scriptPath
