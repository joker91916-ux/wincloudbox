name: Windows-2025 Personal Cloud PC (ngrok + RDP)

on:
  workflow_dispatch:
    inputs:
      ngrok_auth_token:
        description: "Your ngrok auth token"
        required: true
      pc_name:
        description: "Friendly name for your Cloud PC"
        required: true

jobs:
  cloud-pc-job:
    runs-on: windows-2025
    env:
      NGROK_AUTH_TOKEN: ${{ github.event.inputs.ngrok_auth_token }}
      PC_NAME: ${{ github.event.inputs.pc_name }}
    steps:
      - name: Set PC Name
        shell: powershell
        run: |
          Rename-Computer -NewName $env:PC_NAME -Force -Restart:$false
          Write-Output "PC name set to $env:PC_NAME"

      - name: Create CloudPCUSER
        shell: powershell
        run: |
          $username = "CloudPCUSER"
          $password = "WindowsCloudPC#2025"
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force)
              Add-LocalGroupMember -Group "Administrators" -Member $username
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          }

      - name: Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Doing final touches
        shell: powershell
        run: |
          $ngrokZip = "$env:TEMP\ngrok.zip"
          $ngrokExe = "$env:TEMP\ngrok.exe"
          Invoke-WebRequest "https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip" -OutFile $ngrokZip > $null
          Expand-Archive $ngrokZip -DestinationPath $env:TEMP -Force > $null
          & $ngrokExe authtoken $env:NGROK_AUTH_TOKEN > $null
          Start-Process $ngrokExe -ArgumentList "tcp 3389" -WindowStyle Hidden

      - name: Your Cloud PC is booted
        shell: powershell
        run: |
          $username = "CloudPCUSER"
          $password = "WindowsCloudPC#2025"
          $pcName = $env:PC_NAME
          $ngrokExe = "$env:TEMP\ngrok.exe"

          $endTime = (Get-Date).AddHours(5)
          while ((Get-Date) -lt $endTime) {
              $tunnel = & $ngrokExe tunnels list 2>$null | Select-String "tcp"
              if ($tunnel) {
                  $url = ($tunnel -split "\s+")[2]
              } else {
                  $url = "Pending..."
              }
              Write-Output "Your personal Cloud PC $pcName is ready!"
              Write-Output "Login user: $username"
              Write-Output "Password: $password"
              Write-Output "Connect via RDP using ngrok URL: $url"
              Start-Sleep -Seconds 60
          }
          Write-Output "5 hours reached. Cloud PC job completed."
