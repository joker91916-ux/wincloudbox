name: Windows-2025 Personal Cloud PC (Tailscale + RDP)

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: "Tailscale auth key"
        required: true
      pc_name:
        description: "Friendly name for your Cloud PC"
        required: true

jobs:
  cloud-pc-job:
    runs-on: windows-2025
    env:
      TAILSCALE_AUTH_KEY: ${{ github.event.inputs.tailscale_auth_key }}
      PC_NAME: ${{ github.event.inputs.pc_name }}
    steps:
      - name: ‚òÅÔ∏è Cloud PC: Set PC Name
        shell: cmd
        run: |
          powershell -Command "Rename-Computer -NewName '%PC_NAME%' -Force -Restart:$false"
          echo PC name set to %PC_NAME%

      - name: ‚ö° Cloud PC: Create CloudPCUSER
        shell: cmd
        run: |
          net user CloudPCUSER WindowsCloudPC#2025 /add
          net localgroup Administrators CloudPCUSER /add
          net localgroup "Remote Desktop Users" CloudPCUSER /add
          echo CloudPCUSER created and added to Administrators & Remote Desktop Users

      - name: üåê Cloud PC: Install Tailscale
        shell: cmd
        run: |
          powershell -Command "Invoke-WebRequest -Uri 'https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe' -OutFile '%TEMP%\tailscale.exe'"
          msiexec /i "%TEMP%\tailscale.exe" /quiet /norestart
          echo Tailscale installed

      - name: üîë Cloud PC: Authenticate Tailscale
        shell: cmd
        run: |
          "C:\Program Files (x86)\Tailscale IPN\tailscale.exe" up --authkey %TAILSCALE_AUTH_KEY% --hostname %COMPUTERNAME%
          echo Tailscale node authenticated

      - name: üñ•Ô∏è Cloud PC: Enable RDP
        shell: cmd
        run: |
          powershell -Command "Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0"
          powershell -Command "Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'"
          echo Remote Desktop enabled

      - name: ‚è≥ Cloud PC: Keep Alive & Ready
        shell: cmd
        run: |
          set USERNAME=CloudPCUSER
          set PASSWORD=WindowsCloudPC#2025
          set PC_NAME=%PC_NAME%
          
          rem Get Tailscale IP
          for /f "tokens=*" %%i in ('"C:\Program Files (x86)\Tailscale IPN\tailscale.exe" ip -4') do set TAILSCALE_IP=%%i
          for /f "tokens=2 delims=:" %%i in ('"C:\Program Files (x86)\Tailscale IPN\tailscale.exe" status ^| findstr hostname:') do set TAILSCALE_NODE=%%i

          set /a ENDTIME=%TIME:~0,2%*3600 + %TIME:~3,2%*60 + %TIME:~6,2% + 18000

          :LOOP
          echo üéâ Your personal Cloud PC '%PC_NAME%' is ready!
          echo üîë Login user: %USERNAME%
          echo üíª Password: %PASSWORD%
          echo üåê Tailscale IP: %TAILSCALE_IP%
          echo üìõ Tailscale Node Name: %TAILSCALE_NODE%
          echo Connect via RDP using the above credentials.
          timeout /t 60 >nul

          rem Repeat until 5 hours have passed
          for /f "tokens=1-3 delims=:." %%a in ("%time%") do (
              set /a CURTIME=%%a*3600 + %%b*60 + %%c
          )
          if %CURTIME% LSS %ENDTIME% goto LOOP

          echo ‚è∞ 5 hours reached. Cloud PC job completed. ‚úÖ
