name: ‚òÅÔ∏è Cloud PC

on:
  workflow_dispatch:
    inputs:
      pc_name:
        description: "Choose a name for your Cloud PC"
        required: true
      user_name:
        description: "Choose the username for your Cloud PC"
        required: true

jobs:
  build:
    runs-on: windows-latest
    steps:

      - name: ‚è≥ Preparing your Cloud PC...
        run: echo "Starting setup..."

      - name: üñ•Ô∏è Set PC Name
        shell: powershell
        run: |
          Rename-Computer -NewName "${{ github.event.inputs.pc_name }}" -Force

      - name: üë§ Create Cloud PC User
        shell: powershell
        run: |
          $username = "${{ github.event.inputs.user_name }}"
          $password = ConvertTo-SecureString "Act1-1234" -AsPlainText -Force
          New-LocalUser $username -Password $password -FullName "Personal Cloud User" -Description "Cloud PC User"
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          Write-Output "Cloud PC user created: $username"
          Write-Output "Password: Act1-1234"

      - name: ‚ö° Installing Tailscale
        shell: powershell
        run: |
          $tailscaleInstaller = "$env:TEMP\tailscale-setup.exe"
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile $tailscaleInstaller
          Start-Process $tailscaleInstaller -ArgumentList "/quiet /norestart" -Wait

          # Start Tailscale service
          Start-Service Tailscale

          # Authenticate Tailscale using correct path
          $tailscaleExe = "C:\Program Files\Tailscale\tailscale.exe"
          & $tailscaleExe up --authkey "${{ secrets.TAILSCALE_AUTHKEY }}" --hostname "${{ github.event.inputs.pc_name }}" --accept-routes --accept-dns

          Write-Output "‚úÖ Tailscale connected!"
          & $tailscaleExe ip -4

      - name: üé® Apply Dark Theme + Wallpaper
        shell: powershell
        run: |
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v AppsUseLightTheme /t REG_DWORD /d 0 /f
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v SystemUsesLightTheme /t REG_DWORD /d 0 /f
          $wallpaper = "C:\Users\Public\wallpaper.jpg"
          Invoke-WebRequest "https://dl.dropboxusercontent.com/scl/fi/setujqxgeitfcmmvz07du/night-sky-colorful-3840x2160-12510.jpg?rlkey=vve9jvp25sjggpv8hd7228kue&st=71r4yxsm" -OutFile $wallpaper
          reg add "HKCU\Control Panel\Desktop" /v Wallpaper /t REG_SZ /d $wallpaper /f
          RUNDLL32.EXE user32.dll, UpdatePerUserSystemParameters

      - name: üì¶ Install Apps (Discord, Bandicam, Vegas Pro 17)
        shell: powershell
        run: |
          Invoke-WebRequest "https://dl.discordapp.net/apps/win/0.0.309/DiscordSetup.exe" -OutFile "C:\Users\Public\DiscordSetup.exe"
          Start-Process "C:\Users\Public\DiscordSetup.exe" -ArgumentList "/S" -Wait

          Invoke-WebRequest "https://download.bandicam.com/bdcamsetup.exe" -OutFile "C:\Users\Public\bdcamsetup.exe"
          Start-Process "C:\Users\Public\bdcamsetup.exe" -ArgumentList "/S" -Wait

          Invoke-WebRequest "https://dl.dropboxusercontent.com/scl/fi/b2cy5z5lzp1qnsrbh83re/Sony_Vegas17_by-FireDemon.rar?rlkey=trcgq5jt4or0qq8hs052tvnt7&st=rpkfzkkn" -OutFile "C:\Users\Public\Vegas17.rar"

          Write-Output "‚úÖ Discord installed"
          Write-Output "‚úÖ Bandicam installed"
          Write-Output "üì¶ Vegas Pro 17 downloaded (manual extract may be needed)"

      - name: üí¨ Setup Welcome Message
        shell: powershell
        run: |
          $message = "Welcome to Cloud PC! You have a personal computer for 5 hours! When it ends, just relaunch the workflow!"
          $script = "msg * $message"
          $task = "C:\Users\Public\welcome.ps1"
          Set-Content -Path $task -Value $script
          schtasks /create /sc onlogon /tn "WelcomeMessage" /tr "powershell.exe -ExecutionPolicy Bypass -File $task" /ru $env:USERNAME /f

      - name: üöÄ Your Cloud PC is ready!
        shell: powershell
        run: |
          Write-Output "üéâ Your personal Cloud PC is ready!"
          Write-Output "üñ•Ô∏è PC Name: $env:COMPUTERNAME"
          Write-Output "üë§ Username: ${{ github.event.inputs.user_name }}"
          Write-Output "üîë Password: Act1-1234"
          Write-Output "üåê Use the Tailscale IP above to connect via RDP"
          Write-Output "‚ö° Specs: 8-16 GB RAM | 2-4 vCPUs (AMD EPYC) | 256 GB SSD | Internet: ~3-4 Gbps"
