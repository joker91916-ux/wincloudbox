name: Windows-2025 Personal Cloud PC (Tailscale via WSL + RDP)

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: "Your Tailscale auth key"
        required: true
      pc_name:
        description: "Friendly name for your Cloud PC"
        required: true

jobs:
  cloud-pc-job:
    runs-on: windows-2025
    env:
      TAILSCALE_AUTH_KEY: ${{ github.event.inputs.tailscale_auth_key }}
      PC_NAME: ${{ github.event.inputs.pc_name }}
    steps:
      - name: ðŸ–¥ï¸ Preparing PC Name
        shell: powershell
        run: |
          Rename-Computer -NewName $env:PC_NAME -Force -Restart:$false
          Write-Output "PC name set to $env:PC_NAME"

      - name: ðŸ‘¤ Preparing CloudPC User
        shell: powershell
        run: |
          $username = "CloudPCUSER"
          $password = "WindowsCloudPC#2025"
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force)
              Add-LocalGroupMember -Group "Administrators" -Member $username
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          }

      - name: ðŸ”’ Preparing Remote Desktop
        shell: powershell
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: âš¡ Installing Tailscale in WSL
        shell: powershell
        run: |
          wsl --install -d Ubuntu
          wsl sudo apt-get update
          wsl sudo apt-get install -y curl gnupg lsb-release
          wsl curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg > /dev/null
          wsl curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          wsl sudo apt-get update
          wsl sudo apt-get install -y tailscale
          # Start Tailscale with auth key
          wsl sudo tailscale up --authkey $env:TAILSCALE_AUTH_KEY --hostname $env:PC_NAME --accept-routes

      - name: ðŸš€ Finalizing Cloud PC
        shell: powershell
        run: |
          $username = "CloudPCUSER"
          $password = "WindowsCloudPC#2025"
          $pcName = $env:PC_NAME
          $endTime = (Get-Date).AddHours(5)
          while ((Get-Date) -lt $endTime) {
              $tailscaleIP = wsl tailscale ip -4
              $tailscaleNodeName = wsl tailscale status | Select-String "hostname:" | ForEach-Object { ($_ -split ":")[1].Trim() }
              Write-Output "Your personal Cloud PC $pcName is ready!"
              Write-Output "Login user: $username"
              Write-Output "Password: $password"
              Write-Output "Tailscale IP: $tailscaleIP"
              Write-Output "Tailscale Node Name: $tailscaleNodeName"
              Start-Sleep -Seconds 60
          }
          Write-Output "5 hours reached. Cloud PC job completed."
