name: Windows-2025 Personal Cloud PC (Tailscale + RDP)

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: "Tailscale auth key"
        required: true
      pc_name:
        description: "Friendly name for your Cloud PC"
        required: true

jobs:
  cloud-pc-job:
    runs-on: windows-2025
    steps:
      - name: ‚òÅÔ∏è Cloud PC: Set Windows PC Name
        shell: pwsh
        run: |
          $pcName = "${{ github.event.inputs.pc_name }}"
          Rename-Computer -NewName $pcName -Force -Restart:$false
          Write-Output "PC name set to '$pcName'"

      - name: ‚ö° Cloud PC: Create CloudPCUSER
        shell: pwsh
        run: |
          $username = "CloudPCUSER"
          $password = "WindowsCloudPC#2025"
          
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -FullName "Cloud PC User" -Description "Personal Cloud PC User"
              Add-LocalGroupMember -Group "Administrators" -Member $username
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
              Write-Output "User '$username' created and added to Administrators & Remote Desktop Users groups"
          } else {
              Write-Output "User '$username' already exists"
          }

      - name: üåê Cloud PC: Install Tailscale
        shell: pwsh
        run: |
          $tailscaleInstaller = "$env:TEMP\tailscale-setup.exe"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile $tailscaleInstaller
          Start-Process -FilePath $tailscaleInstaller -ArgumentList "/quiet /norestart" -Wait
          Write-Output "Tailscale installed"

      - name: üîë Cloud PC: Authenticate Tailscale
        shell: pwsh
        env:
          TAILSCALE_AUTH_KEY: ${{ github.event.inputs.tailscale_auth_key }}
        run: |
          Start-Process -FilePath "C:\Program Files (x86)\Tailscale IPN\tailscale.exe" -ArgumentList "up --authkey $env:TAILSCALE_AUTH_KEY --hostname $env:COMPUTERNAME" -Wait
          Write-Output "Tailscale node authenticated"

      - name: üñ•Ô∏è Cloud PC: Enable RDP
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Output "Remote Desktop enabled"

      - name: ‚è≥ Cloud PC: Ready to Use!
        shell: pwsh
        run: |
          $username = "CloudPCUSER"
          $password = "WindowsCloudPC#2025"
          $pcName = "${{ github.event.inputs.pc_name }}"

          $tailscaleIP = & "C:\Program Files (x86)\Tailscale IPN\tailscale.exe" ip -4 | ForEach-Object { $_.Trim() }
          $tailscaleNodeName = & "C:\Program Files (x86)\Tailscale IPN\tailscale.exe" status | Select-String "hostname:" | ForEach-Object { ($_ -split ":")[1].Trim() }

          Write-Output "üéâ Your personal Cloud PC '$pcName' is ready!"
          Write-Output "üîë Login user: $username"
          Write-Output "üíª Password: $password"
          Write-Output "üåê Tailscale IP: $tailscaleIP"
          Write-Output "üìõ Tailscale Node Name: $tailscaleNodeName"
          Write-Output "Connect via RDP to this Cloud PC using the above credentials."
