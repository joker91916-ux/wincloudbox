name: Windows-2025 Personal Cloud PC (Supremo)

on:
  workflow_dispatch:
    inputs:
      pin:
        description: 'PIN for your Cloud PC (4-6 digits)'
        required: true
      name:
        description: 'Friendly name for your Cloud PC'
        required: true

jobs:
  cloud-pc-job:
    runs-on: windows-2025
    steps:
      - name: ‚òÅÔ∏è Cloud PC: Initialize Download
        shell: pwsh
        run: |
          $url = "https://www.nanosystems.it/public/download/Supremo.exe"
          $output = "$env:TEMP\Supremo.exe"
          Write-Output "Downloading the Cloud PC remote control software..."
          Invoke-WebRequest -Uri $url -OutFile $output
          Write-Output "Cloud PC software downloaded to $output"

      - name: ‚ö° Cloud PC: Start & Configure
        shell: pwsh
        env:
          CLOUDPC_PIN: ${{ github.event.inputs.pin }}
          CLOUDPC_NAME: ${{ github.event.inputs.name }}
        run: |
          $pin = $env:CLOUDPC_PIN
          $cloudPCName = $env:CLOUDPC_NAME
          $supremoPath = "$env:TEMP\Supremo.exe"

          Write-Output "Starting your Cloud PC '$cloudPCName'..."
          Start-Process -FilePath $supremoPath -ArgumentList "/PIN $pin /NAME $cloudPCName /RUN" -WindowStyle Hidden
          Start-Sleep -Seconds 5

          # Extract Supremo ID from window title
          Add-Type @"
          using System;
          using System.Runtime.InteropServices;
          public class WinAPI {
              [DllImport("user32.dll", SetLastError = true)]
              public static extern int GetWindowText(IntPtr hWnd, System.Text.StringBuilder text, int count);
              [DllImport("user32.dll", SetLastError = true)]
              public static extern bool EnumWindows(EnumWindowsProc lpEnumFunc, IntPtr lParam);
              public delegate bool EnumWindowsProc(IntPtr hWnd, IntPtr lParam);
          }
"@

          $supremoID = ""
          $null = [WinAPI]::EnumWindows({ param($hWnd, $lParam)
              $sb = New-Object System.Text.StringBuilder 1024
              [WinAPI]::GetWindowText($hWnd, $sb, $sb.Capacity) | Out-Null
              $text = $sb.ToString()
              if ($text -match "Supremo ID: (\d+)") {
                  $supremoID = $matches[1]
                  return $false # stop enumerating
              }
              return $true
          }, [IntPtr]::Zero)

          Write-Output "üíª Your personal Cloud PC '$cloudPCName' is running!"
          Write-Output "üÜî Cloud PC ID: $supremoID"
          Write-Output "üîë PIN: $pin"
          Write-Output "Connect from your Android or desktop app using this ID and PIN."

      - name: ‚è≥ Cloud PC: Ready to Use!
        shell: pwsh
        env:
          CLOUDPC_NAME: ${{ github.event.inputs.name }}
          CLOUDPC_PIN: ${{ github.event.inputs.pin }}
        run: |
          $durationHours = 5
          $durationSeconds = $durationHours * 3600
          $startTime = Get-Date
          $cloudPCName = $env:CLOUDPC_NAME
          $pin = $env:CLOUDPC_PIN
          $ram = "8‚Äì16 GB"
          $storage = "256 GB (C:) + smaller D: drive"
          $cpu = "AMD EPYC (2‚Äì4 vCores)"

          while ((Get-Date) - $startTime -lt (New-TimeSpan -Seconds $durationSeconds)) {
              Write-Output "üéâ Enjoy using your Cloud PC! üíª '$cloudPCName'"
              Write-Output "üñ•Ô∏è Specs: RAM: $ram | Storage: $storage | CPU: $cpu"
              Write-Output "üîë Supremo PIN: $pin"
              Write-Output "This Cloud PC runs for 6 hours. ‚è∞"
              Write-Output "To get a new Cloud PC, simply relaunch this workflow. üöÄ"
              Start-Sleep -Seconds 5
          }

          Write-Output "‚è∞ 5 hours reached. Cloud PC job completed. ‚úÖ"
